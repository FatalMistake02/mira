name: Build Release
run-name: Build Release ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag_version.outputs.version }}
      release_tag: ${{ steps.tag_version.outputs.release_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Resolve version from tag
        id: tag_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            tag="${{ github.event.inputs.tag }}"
          else
            tag="${{ github.ref_name }}"
          fi
          tag="${tag#refs/tags/}"
          version="${tag#v}"
          version="${version#V}"
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([-+][0-9A-Za-z.-]+)?$ ]]; then
            echo "Tag '$tag' does not contain a valid semver version."
            exit 1
          fi
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Apply tag version to package metadata
        run: npm version ${{ steps.tag_version.outputs.version }} --no-git-tag-version

      - name: Update changelog release header
        shell: bash
        run: |
          changelog_file="CHANGELOG.md"
          release_date="$(date -u +%Y-%m-%d)"
          release_heading="## v${{ steps.tag_version.outputs.version }} - $release_date"

          if grep -qF "$release_heading" "$changelog_file"; then
            echo "Changelog already contains release heading: $release_heading"
            exit 0
          fi

          if ! grep -qE '^## Unreleased$' "$changelog_file"; then
            echo "CHANGELOG.md does not contain an '## Unreleased' section."
            exit 1
          fi

          tmp_file="$(mktemp)"
          awk -v heading="$release_heading" '
            BEGIN { replaced=0 }
            !replaced && $0=="## Unreleased" {
              print "## Unreleased"
              print ""
              print heading
              replaced=1
              next
            }
            { print }
            END {
              if (!replaced) {
                exit 1
              }
            }
          ' "$changelog_file" > "$tmp_file"
          mv "$tmp_file" "$changelog_file"

      - name: Upload versioned package metadata
        uses: actions/upload-artifact@v4
        with:
          name: package-metadata
          path: |
            package.json
            package-lock.json

      - name: Sync package version to repository
        shell: bash
        run: |
          default_branch="${{ github.event.repository.default_branch }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin "$default_branch"

          worktree_dir="$(mktemp -d)"
          git worktree add "$worktree_dir" "origin/$default_branch"

          cp package.json "$worktree_dir/package.json"
          cp package-lock.json "$worktree_dir/package-lock.json"
          cp CHANGELOG.md "$worktree_dir/CHANGELOG.md"

          cd "$worktree_dir"
          git add package.json package-lock.json CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No package/changelog changes to commit."
            exit 0
          fi
          git commit -m "chore: set version to ${{ steps.tag_version.outputs.version }} from tag ${{ steps.tag_version.outputs.release_tag }}"
          git push origin HEAD:"$default_branch"

  build-windows:
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download versioned package metadata
        uses: actions/download-artifact@v4
        with:
          name: package-metadata
          path: .

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build -- --publish never
        env:
          VITE_DEV: "false"

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ needs.prepare-version.outputs.release_tag }}
          files: release/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs:
      - prepare-version
      - build-windows
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download versioned package metadata
        uses: actions/download-artifact@v4
        with:
          name: package-metadata
          path: .

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build -- --mac --x64 --arm64 --publish never
        env:
          VITE_DEV: "false"

      - name: Upload macOS Assets to Existing Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ needs.prepare-version.outputs.release_tag }}
          files: |
            release/*.dmg
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    needs:
      - prepare-version
      - build-macos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download versioned package metadata
        uses: actions/download-artifact@v4
        with:
          name: package-metadata
          path: .

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build -- --linux --x64 --publish never
        env:
          VITE_DEV: "false"

      - name: Upload Linux Assets to Existing Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ needs.prepare-version.outputs.release_tag }}
          files: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
