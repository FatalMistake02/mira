name: Build Windows

on:
  push:
    tags:
      - "*"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Build app
      - name: Build app
        run: npm run build

      # 5. Create GitHub release draft
      - name: Create GitHub Release Draft
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. Upload each .exe
      - name: Upload Windows artifacts
        shell: pwsh
        run: |
          $releaseUrl = "${{ steps.create_release.outputs.upload_url }}"
          Get-ChildItem -Path "release" -Filter "*.exe" | ForEach-Object {
            Write-Host "Uploading $($_.Name)"
            gh api \
              -X POST "$releaseUrl/assets?name=$($_.Name)" \
              -H "Content-Type: application/octet-stream" \
              --input $_.FullName
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
